---
sidebar_position: 7
---

import ExplanationEngine from "@site/static/schemas/explanationEngine.json";
import JSONSchemaViewer from "@theme/JSONSchemaViewer";
import generateResolverOptions from "@site/src/components/shared-lib/generateResolverOptions.tsx";
import InlineSchemaDisplay from '@site/src/components/InlineSchemaDisplay';
import CodeBlock from '@theme/CodeBlock';

# Explanation Engine

This documentation guides how to integrate an explanation engine into your smart home study. The explanation engine provides automated feedback and explanations to participants based on their interactions with devices and rules. Two approaches exist for integrating explanations: using the integrated engine or connecting to a custom API endpoint.

## Core Configuration

The explanation engine configuration is defined in a separate `explanation.json` file (not part of the main game schema). This file controls when explanations are issued and which type of explanation system is used.

### Complete Configuration Example

```json
{
    "explanation_trigger": "on_demand",
    "explanation_engine": "integrated",
    "explanation_rating": "like",
    "allow_user_message": false,
    "integrated_explanation_engine": {
        "deep_fryer_01": "The deep fryer automatically turns off when the cooker hood is not running. This is a safety feature to prevent smoke buildup.",
        "mixer_01": "The mixer is automatically disabled after 22:00 to reduce noise for neighbors.",
        "lamp_01": "The lamp automatically turns on when you open a book to provide adequate reading light."
    }
}
```

### Property: Explanation Trigger

Controls when explanations are shown to participants:

- **`on_demand`**: Explanations are cached when rule conditions trigger, but only shown when the user clicks "Explain Me!" button. This allows participants to discover contradictions first before seeking explanations.
- **`automatic`**: Explanations are shown immediately when rule conditions are met or when the external explanation engine emits an explanation.

```json
{
    "explanation_trigger": "on_demand"
}
```

:::tip Choosing Trigger Type
Use **on_demand** for impossible task studies where you want participants to discover issues independently before seeking help. Use **automatic** for educational scenarios where immediate feedback is beneficial.
:::

### Property: Explanation Engine

Defines the backbone technology for generating explanations:

- **`integrated`**: Uses the built-in explanation engine suitable for simple, rule-based explanations that don't require complex logic or dynamic content generation.
- **`external`**: Connects to a custom explanation engine for advanced use cases requiring machine learning, natural language generation, or complex contextual analysis.

```json
{
    "explanation_engine": "integrated"
}
```

When using `external`, you must also specify the communication protocol:

```json
{
    "explanation_engine": "external",
    "external_engine_type": "rest",
    "external_explanation_engine_api": "https://your-api.com/explanation"
}
```

### Property: External Engine Type

Required when using `external` explanation engine:

- **`rest`**: Uses REST API communication with `/logger` and `/explanation` endpoints
- **`ws`**: Uses WebSocket communication for real-time bidirectional messaging

```json
{
    "external_engine_type": "rest",
    "external_explanation_engine_api": "https://example.com/engine"
}
```

```json
{
    "external_engine_type": "ws",
    "external_explanation_engine": "ws://example.com:8080"
}
```

### Property: Allow User Messages

Enables interactive communication between participants and external explanation engines:

```json
{
    "allow_user_message": true
}
```

When enabled, participants can send custom messages to the explanation engine, enabling:
- **Clarification requests**: "Why did the coffee machine turn off?"
- **Context gathering**: Understanding participant intent and confusion
- **Personalized explanations**: Tailored responses based on user questions

:::info Interactive Explanations
This feature is particularly useful for studies investigating explanation effectiveness and user comprehension patterns.
:::

### Property: Explanation Rating

Enables participants to rate explanation usefulness:

```json
{
    "explanation_rating": "like"
}
```

Currently supports `"like"` rating system (thumbs up/down), which helps:
- **Evaluate explanation quality**: Measure participant satisfaction
- **Improve explanation systems**: Identify which explanations are most helpful
- **Research data collection**: Gather feedback on explanation effectiveness

### JSON Schema

<JSONSchemaViewer schema={ ExplanationEngine } resolverOptions={generateResolverOptions({"basePath": "/schemas"})} />

<details>
    <summary>JSON Schema Code</summary>

    <InlineSchemaDisplay 
    schema={ExplanationEngine} 
    resolverOptions={generateResolverOptions({"basePath": "/schemas"})} 
    title="Explanation Engine Schema"
    />
</details>

## Integrated Explanation Engine

The integrated explanation engine provides a straightforward approach for rule-based explanations without requiring external infrastructure.

### Setup Configuration

```json
{
    "explanation_trigger": "on_demand",
    "explanation_engine": "integrated",
    "integrated_explanation_engine": {
        "deep_fryer_01": "The deep fryer only operates when the cooker hood is active for safety reasons.",
        "mixer_01": "The mixer automatically shuts off after 22:00 to comply with noise regulations.",
        "lamp_01": "The reading lamp activates automatically when you open a book."
    }
}
```

### When Explanations Are Shown

The timing depends on your `explanation_trigger` setting:

#### Automatic Mode
- Explanations appear immediately when rule actions are triggered
- Suitable for educational scenarios where immediate feedback helps learning
- May reduce participant problem-solving time

#### On-Demand Mode
- Explanations are cached when rules trigger but not shown immediately
- Participants must click "Explain Me!" to view cached explanations
- Viewing an explanation clears the cache
- Ideal for impossible task studies where discovery is important

### Creating Explanations

Define explanations as key-value pairs where:
- **Key**: Explanation ID referenced in rule actions
- **Value**: Explanation text (supports HTML formatting)

```json
{
    "integrated_explanation_engine": {
        "coffee_machine_01": "The coffee machine turns off automatically after making 5 cups to prevent overheating.",
        "security_system_01": "The security system <strong>requires all doors to be locked</strong> before activation.",
        "thermostat_01": "Energy saving mode automatically reduces temperature during <em>unoccupied hours</em>."
    }
}
```

### Integration with Rules

Reference explanation IDs in rule actions:

```json
{
    "name": "Coffee Machine Auto-Off",
    "precondition": [
        {
            "type": "Device",
            "device": "coffee_machine",
            "condition": {
                "name": "Cups Made",
                "operator": ">=",
                "value": 5
            }
        }
    ],
    "action": [
        {
            "type": "Device_Interaction",
            "device": "coffee_machine",
            "interaction": {
                "name": "Power",
                "value": false
            }
        },
        {
            "type": "Explanation",
            "explanation": "coffee_machine_01"
        }
    ]
}
```

## External Explanation Engine

External explanation engines enable sophisticated explanation generation using custom logic, machine learning, or integration with existing systems.

### REST API Implementation

#### Setup Configuration

```json
{
    "explanation_trigger": "automatic",
    "explanation_engine": "external",
    "external_engine_type": "rest",
    "external_explanation_engine_api": "https://your-domain.com/engine",
    "allow_user_message": true,
    "explanation_rating": "like"
}
```

#### Required API Endpoints

Your API must implement two endpoints:

##### POST `/logger`

Called whenever participants interact with devices or when system events occur.

**Request Payload:**
```json
{
    "user_id": "64bdb062-cb25-487f-8373-c56ac18fba5a",
    "current_task": "make_coffee",
    "ingame_time": "08:32",
    "environment": [
        { "name": "Weather", "value": "Sunny" },
        { "name": "Temperature", "value": 20 }
    ],
    "devices": [
        {
            "device": "coffee_machine",
            "interactions": [
                {
                    "name": "Power",
                    "value": true
                },
                {
                    "name": "Cups Made",
                    "value": 3
                }
            ]
        }
    ],
    "logs": [
        {
            "type": "DEVICE_INTERACTION",
            "device_id": "coffee_machine",
            "interaction": {
                "name": "Power",
                "value": true
            },
            "timestamp": 1739280520
        }
    ]
}
```

##### POST `/explanation`

Called when participants request explanations on-demand.

**Standard Request:**
```json
{
    "user_id": "64bdb062-cb25-487f-8373-c56ac18fba5a"
}
```

**Request with User Message:**
```json
{
    "user_id": "64bdb062-cb25-487f-8373-c56ac18fba5a",
    "user_message": "Why did the coffee machine suddenly turn off?"
}
```

#### API Response Format

**Show Explanation:**
```json
{
    "success": true,
    "show_explanation": true,
    "explanation": "The coffee machine automatically turns off after making 5 cups to prevent overheating and ensure optimal coffee quality."
}
```

**No Explanation:**
```json
{
    "success": true,
    "show_explanation": false
}
```

### WebSocket Implementation

#### Setup Configuration

```json
{
    "explanation_trigger": "on_demand",
    "explanation_engine": "external",
    "external_engine_type": "ws",
    "external_explanation_engine": "ws://your-domain.com:8080",
    "allow_user_message": true
}
```

#### WebSocket Events

##### Outgoing: `user_log`

Sent whenever participant actions generate logs:

```json
{
    "user_id": "64bdb062-cb25-487f-8373-c56ac18fba5a",
    "current_task": "make_coffee",
    "ingame_time": "08:32",
    "environment": [
        { "name": "Weather", "value": "Sunny" }
    ],
    "devices": [
        {
            "device": "coffee_machine",
            "interactions": [
                {
                    "name": "Power",
                    "value": true
                }
            ]
        }
    ],
    "logs": {
        "type": "DEVICE_INTERACTION",
        "device_id": "coffee_machine",
        "interaction": {
            "name": "Power",
            "value": true
        },
        "timestamp": 1739280520
    }
}
```

##### Outgoing: `explanation_request`

Sent when participants request explanations:

```json
{
    "user_id": "64bdb062-cb25-487f-8373-c56ac18fba5a",
    "timestamp": 1739792380,
    "user_message": "Why can't I turn on the deep fryer?"
}
```

##### Incoming: `explanation_receival`

Receive explanations from your server:

```json
{
    "user_id": "64bdb062-cb25-487f-8373-c56ac18fba5a",
    "explanation": "The deep fryer requires the cooker hood to be active for safety ventilation.",
    "enforce_automatic_explanation": false
}
```

Set `enforce_automatic_explanation: true` to override on-demand settings and show explanations immediately.

## Log Types Reference

The explanation engine receives detailed logs about participant interactions. Understanding these log types helps in building effective explanation logic.

### DEVICE_INTERACTION

Generated when participants change device settings:

```json
{
    "type": "DEVICE_INTERACTION",
    "metadata": {
        "device_id": "deep_fryer",
        "interaction": {
            "name": "Power",
            "value": true
        }
    },
    "timestamp": 1748860205
}
```

### RULE_TRIGGER

Generated when smart home rules activate:

```json
{
    "type": "RULE_TRIGGER",
    "metadata": {
        "rule_id": "deep_fryer_rule",
        "rule_action": [
            {
                "device": "deep_fryer",
                "property": {
                    "name": "Power",
                    "value": false
                }
            }
        ]
    },
    "timestamp": 1748860205
}
```

### TASK_BEGIN

Generated when a new task starts:

```json
{
    "type": "TASK_BEGIN",
    "metadata": {
        "task_id": "make_coffee"
    },
    "timestamp": 1748860190
}
```

### TASK_COMPLETED

Generated when participants successfully complete all task goals:

```json
{
    "type": "TASK_COMPLETED",
    "metadata": {
        "task_id": "make_coffee"
    },
    "timestamp": 1748862020
}
```

### TASK_TIMEOUT

Generated when a task expires due to time limit before completion:

```json
{
    "type": "TASK_TIMEOUT",
    "metadata": {
        "task_id": "make_coffee"
    },
    "timestamp": 1748862033
}
```

### ROOM_SWITCH

Generated when participants move between rooms using doors:

```json
{
    "type": "ROOM_SWITCH",
    "metadata": {
        "destination_room": "kitchen",
        "destination_wall": "wall1"
    },
    "timestamp": 1748860201
}
```

### WALL_SWITCH

Generated when participants navigate between walls within the same room:

```json
{
    "type": "WALL_SWITCH",
    "metadata": {
        "room": "Shared Room",
        "wall": "0"
    },
    "timestamp": 1748860200
}
```

### ENTER_DEVICE_CLOSEUP

Generated when participants click on a device to enter its detailed interaction view:

```json
{
    "type": "ENTER_DEVICE_CLOSEUP",
    "metadata": {
        "device": "coffee_machine"
    },
    "timestamp": 1748860202
}
```

### EXIT_DEVICE_CLOSEUP

Generated when participants exit from device closeup view back to wall view:

```json
{
    "type": "EXIT_DEVICE_CLOSEUP",
    "metadata": {
        "device": "coffee_machine"
    },
    "timestamp": 1748860203
}
```

### ABORT_TASK

Track when participants abandon tasks:

```json
{
    "type": "ABORT_TASK",
    "metadata": {
        "task_id": "make_coffee",
        "abort_reason": "I believe this task is impossible."
    },
    "timestamp": 1748862023
}
```

## Implementation Examples

### Study: Impossible Task Detection

```json
{
    "explanation_trigger": "on_demand",
    "explanation_engine": "integrated",
    "explanation_rating": "like",
    "integrated_explanation_engine": {
        "contradiction_01": "This task cannot be completed because the security system prevents the coffee machine from operating during night hours.",
        "safety_override_01": "The smoke detector has triggered an automatic shutdown of all kitchen appliances.",
        "energy_limit_01": "The home's energy management system has reached its daily limit and disabled non-essential devices."
    }
}
```

### Study: AI-Powered Explanations

```json
{
    "explanation_trigger": "automatic",
    "explanation_engine": "external",
    "external_engine_type": "rest",
    "external_explanation_engine_api": "https://ai-explainer.your-lab.edu/api",
    "allow_user_message": true,
    "explanation_rating": "like"
}
```

Your external API can then use machine learning to generate contextual explanations:
- Analyze participant behavior patterns
- Provide personalized explanations based on user expertise
- Generate natural language explanations dynamically
- Learn from user ratings to improve explanation quality